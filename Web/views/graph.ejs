<html>
	<style>
		#cy {
    width: 100%;
    height: 100%;
    position: absolute;
    left: 0;
    top: 50 !important;
    z-index: 999;
}

.qtip{
	
	max-width: 421px !important;
	min-width: 50px;
}

div.scroll {
  width: 410px;
  height: 230px;
  overflow: scroll;
}
	</style>

<head>
	<title>graph</title>
	<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1">
	<link href="/css/style.css" rel="stylesheet" />
	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/qtip2/2.2.0/jquery.qtip.css">

	<script src="https://code.jquery.com/jquery-2.1.3.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/qtip2/2.2.0/jquery.qtip.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.21.0/cytoscape.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/cytoscape-qtip2@0.0.2/cytoscape-qtip.min.js"></script>
	<script type="text/javascript">
		$(function () {
			
			let nodeList = [];
			let edgeList = [];
			//console.log(response);
			let data = <%- JSON.stringify(trackSeqs) %>
			let error = <%- error %>
			console.log(error)
			
			//document.write(data);
			// for(let trackSeq of data){
			// 	//console.log(trackSeq.request["id.orig_p"]);
			// 	nodeList.push( {data: { id: trackSeq.request["id.orig_p"], type: "Src"}})
			// 	nodeList.push( {data: { id: trackSeq.request["id.resp_p"], type: "Res"}})
			// 	edgeList.push( {data: { source: trackSeq.request["id.orig_p"], target: trackSeq.request["id.resp_p"], uri: trackSeq.request.uri}})
			// 	edgeList.push( {data: { source: trackSeq.request["id.resp_p"], target: trackSeq.request["id.orig_p"], uri: trackSeq.request.status_code}})
			// 	for(let subrequest of trackSeq.subrequest){
			// 		nodeList.push( {data: { id: subrequest["id.orig_p"], type: "Src"}})
			// 		nodeList.push( {data: { id: subrequest["id.resp_p"], type: "Res"}})
			// 		edgeList.push( {data: { source: subrequest["id.orig_p"], target: subrequest["id.resp_p"], uri: subrequest.uri}})
			// 		edgeList.push( {data: { source: subrequest["id.resp_p"], target: subrequest["id.orig_p"], uri: trackSeq.request.status_code}})
			// 	}
			// }

			if(error == true){
				for(let trackSeq of data){
				//console.log(trackSeq.request["id.orig_p"]);
				nodeList.push( {data: { id: "Client", label: "Client", type: "Src", group: "triangle"}})
				nodeList.push( {data: { id: "BFF", label: "BFF", type: "Res"}})
				if(trackSeq.request.status_code >= 500 && trackSeq.request.status_code < 600 ){
					edgeList.push( {data: { 
						source: "Client", 
						target: "BFF", 
						uri: trackSeq.request.uri, 
						status: trackSeq.request.status_code, 
						exception: trackSeq.request.exception,
						post_body: trackSeq.request.post_body,  
						label: trackSeq.request.method  + " " + trackSeq.request.uri, 
						color: "orange"}})
				} else {
					edgeList.push( {data: { 
						source: "Client", 
						target: "BFF", 
						uri: trackSeq.request.uri, 
						status: trackSeq.request.status_code, 
						exception: "No Exception",
						post_body: trackSeq.request.post_body, 
						label: trackSeq.request.method + " " + trackSeq.request.uri}})
				}
				
				//edgeList.push( {data: { source: "BFF", target: "Client", uri: trackSeq.request.status_code}})
				for(let subrequest of trackSeq.subrequest){
					//nodeList.push( {data: { id: subrequest["id.orig_p"], type: "Src"}})
					nodeList.push( {data: { id: subrequest["id.resp_h"] + " : " + subrequest["id.resp_p"], label: subrequest["id.resp_h"] + " : " + subrequest["id.resp_p"],type: "Res"}})
					if(subrequest.status_code  >= 500 && subrequest.status_code < 600 ){
						edgeList.push( {data: { 
							source: subrequest["id.resp_h"] + " : " + subrequest["id.resp_p"], 
							target: "BFF", uri: subrequest.uri, 
							status: subrequest.status_code, 
							exception: subrequest.exception,
							post_body: subrequest.post_body,  
							label: subrequest.method + " " + subrequest.uri, 
							color: "orange"}})
					} else {
						edgeList.push( {data: { 
							source: subrequest["id.resp_h"] + " : " + subrequest["id.resp_p"], 
							target: "BFF", uri: subrequest.uri, 
							status: subrequest.status_code, 
							exception: "No Exception",
							post_body: subrequest.post_body,   
							label: subrequest.method + " " +subrequest.uri}})
					}
					//edgeList.push( {data: { source: "BFF", target: subrequest["id.resp_p"], uri: subrequest.status_code}})
				}
			}


			} else {
				for(let trackSeq of data){
				//console.log(trackSeq.request["id.orig_p"]);
				nodeList.push( {data: { id: "Client", label: "Client", type: "Src", group: "triangle"}})
				nodeList.push( {data: { id: "BFF", label: "BFF", type: "Res"}})
				if(trackSeq.request.exception){
					edgeList.push( {data: { 
						source: "Client", 
						target: "BFF", 
						uri: trackSeq.request.uri, 
						status: trackSeq.request.status_code, 
						exception: trackSeq.request.exception,
						post_body: trackSeq.request.post_body,  
						label: trackSeq.request.method  + " " + trackSeq.request.uri, 
						color: "red"}})
				} else {
					edgeList.push( {data: { 
						source: "Client", 
						target: "BFF", 
						uri: trackSeq.request.uri, 
						status: trackSeq.request.status_code, 
						exception: "No Exception",
						post_body: trackSeq.request.post_body, 
						label: trackSeq.request.method + " " + trackSeq.request.uri}})
				}
				
				//edgeList.push( {data: { source: "BFF", target: "Client", uri: trackSeq.request.status_code}})
				for(let subrequest of trackSeq.subrequest){
					//nodeList.push( {data: { id: subrequest["id.orig_p"], type: "Src"}})
					nodeList.push( {data: { id: subrequest["id.resp_h"] + " : " + subrequest["id.resp_p"], label: subrequest["id.resp_h"] + " : " + subrequest["id.resp_p"],type: "Res"}})
					if(subrequest.exception){
						edgeList.push( {data: { 
							source: subrequest["id.resp_h"] + " : " + subrequest["id.resp_p"], 
							target: "BFF", uri: subrequest.uri, 
							status: subrequest.status_code, 
							exception: subrequest.exception,
							post_body: subrequest.post_body,  
							label: subrequest.method + " " + subrequest.uri, 
							color: "red"}})
					} else {
						edgeList.push( {data: { 
							source: subrequest["id.resp_h"] + " : " + subrequest["id.resp_p"], 
							target: "BFF", uri: subrequest.uri, 
							status: subrequest.status_code, 
							exception: "No Exception",
							post_body: subrequest.post_body,   
							label: subrequest.method + " " +subrequest.uri}})
					}
					//edgeList.push( {data: { source: "BFF", target: subrequest["id.resp_p"], uri: subrequest.status_code}})
				}
			}

			}

			
			console.log(nodeList);
			console.log(edgeList);
			let cy = cytoscape({
				container: document.getElementById('cy'),
				style: [
					{
						selector: 'node',
						"style": {
    						"shape": "data(group)",
							"label": "data(id)"
  						},
						css: {
							width: 50,
							height: 50,
							//'background-color': '#61bffc',
							content: 'data(id)'
						}

					},

					{
						selector: "edge",
						style: {
							width: 2,
							"source-arrow-shape": "triangle",
							"target-arrow-shape": "triangle",
							'target-arrow-color': 'data(color)',
							'source-arrow-color': 'data(color)',
							"line-color": "data(color)",
							
							"curve-style": "bezier",
							content: 'data(uri)'
						}
					},
					{
						selector: "edge[label]",
						css: {
							"label": "data(label)",
							"text-rotation": "autorotate",
							"text-margin-x": "0px",
							"text-margin-y": "0px",
							"font-size": "13px",
							}
					}
				],
				elements: {


					nodes: nodeList,
					edges: edgeList
				},
				layout: {
					name: 'grid',
					directed: true,
					padding: 10,
					nodeDimensionsIncludeLabels: true,
					cols: 3,
					rows: 2,
					spacingFactor: 1,
					avoidOverlap: true,
					/* color: "#ffff00",*/
					fit: true
				}
			});
			//cy.on('mouseover', 'edge', function(event){
					//console.log("test");
					cy.elements('edge').qtip({
					content: function(){ return '<div class="scroll"><b>Status Code:</b> ' + this.attr('status') + '<br> <b>Exception:</b> ' + this.attr('exception') + '<br> <b>Response body:</b> '+ this.attr('post_body') +'</div>'},
					position: {
						my: 'top center',
						at: 'bottom center'
					},
					style: {
						classes: 'qtip-bootstrap',
						tip: {
							width: 18,
							height: 10
						},
						overflow: scroll
					}
				});
			//});
			

		});

	</script>

</head>

<body>
	<h1>Graph Visualization</h1>
	<% if(resultId === null){ %>
	<div>
		<a href="/result" class="mb-4">&lt;Go Back</a>
	</div>
	<% } else {%> 
		<div>
			<a href="/resulthis/<%= resultId%>" class="mb-4">&lt;Go Back</a>
		</div>
		<% } %> 
	
	<div id="cy"></div>
	<!-- Load application code at the end to ensure DOM is loaded -->
	<!-- <script type="module" src="/js/index.js">
	</script> -->
</body>

</html>